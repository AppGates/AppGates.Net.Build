<Project>

  <PropertyGroup>
    <IsPackable>false</IsPackable>
    <EnableDefaultItems>false</EnableDefaultItems>
    <GenerateDependencyFile>False</GenerateDependencyFile>
    <AdditionalBuildArguments Condition="'$(AdditionalBuildArguments)' == ''"></AdditionalBuildArguments>
  </PropertyGroup>


  <Target Name="PackSolution" AfterTargets="Pack" Condition="'$(SkipSolutionOperation)' != 'true'">
    <Message Text="Pipeline Entry Target: PackSolution" Importance="high"/>
    <ItemGroup>
      <SolutionFileToPack Include="src\*.sln" />
    </ItemGroup>
    <PropertyGroup>
      <PipelineEntryTarget>PackSolution</PipelineEntryTarget>
      <InnerBuildCommand>dotnet pack %(SolutionFileToPack.Identity) /p:SkipSolutionOperation=true $(AdditionalBuildArguments)</InnerBuildCommand>
    </PropertyGroup>
    <Message Text="Pipeline Entry Target: PackSolution" Importance="high"/>
    <CallTarget Targets="LogPipelineEntry"/>
    <Exec Command="$(InnerBuildCommand)" />
  </Target>

  <Target Name="BuildSolution" AfterTargets="Build" Condition="'$(BuildingInsideVisualStudio)' != 'true' AND '$(SkipSolutionOperation)' != 'true'">
    <ItemGroup>
      <SolutionFileToPack Include="src\*.sln" />
    </ItemGroup>
    <PropertyGroup>
      <PipelineEntryTarget>PackSolution</PipelineEntryTarget>
      <InnerBuildCommand>dotnet build %(SolutionFileToPack.Identity) /p:SkipSolutionOperation=true $(AdditionalBuildArguments)</InnerBuildCommand>
    </PropertyGroup>

    <CallTarget Targets="LogPipelineEntry"/>
    <Exec Condition="'$(BuildingInsideVisualStudio)' != 'true'" Command="dotnet restore %(SolutionFileToPack.Identity) --force-evaluate /p:SkipSolutionOperation=true" />
    <Exec Command="$(InnerBuildCommand)" />
  </Target>

  <Target Name="Test" AfterTargets="VSTest" Condition="'$(BuildingInsideVisualStudio)' != 'true' AND '$(SkipSolutionOperation)' != 'true'">
    <ItemGroup>
      <SolutionFileToPack Include="src\*.sln" />
    </ItemGroup>
    <Exec Command="dotnet test %(SolutionFileToPack.Identity) /p:SkipSolutionOperation=true $(AdditionalBuildArguments)" />
  </Target>

  <Target Name="CleanSolution" AfterTargets="CleanOnly" Condition="'$(SkipSolutionOperation)' != 'true'">
    <Message Importance="high" Text="Clear nuget http-cache...." />
    <Exec Command="dotnet nuget locals http-cache --clear" />
    <ItemGroup>
      <SolutionFileToPack Include="src\*.sln" />
    </ItemGroup>
    <Exec Command="dotnet restore %(SolutionFileToPack.Identity) --force-evaluate /p:SkipSolutionOperation=true $(AdditionalBuildArguments)" />

  </Target>

  <Target Name="DeployPages">
    <ItemGroup>
      <InputFile Include="*.*"/>
    </ItemGroup>
    <Message Text ="Deployed: %(InputFile.Identity)" Importance="high"/>

    <Unzip SourceFiles="$(PackageOutputPath)\pages.zip" DestinationFolder="public"/>

    <ItemGroup>
      <DeployedFile Include="public\**\*.*"/>
    </ItemGroup>
    <Message Text ="Deployed: %(DeployedFile.Identity)" Importance="high"/>
  </Target>

  <Target Name="LogPipelineEntry">
    <Message Text="Pipeline Entry Target: $(PipelineEntryTarget)" Importance="high"/>
    <Message Text="Pipeline Inner Build Command(s): $(InnerBuildCommand)" Importance="high"/>
  </Target>
</Project>